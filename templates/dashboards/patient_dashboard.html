{% extends 'includes/base.html' %}
{% load static %}

{% block title %}Patient Dashboard{% endblock %}

{% block use_dna_left %}
    <canvas id="dna-left" class="dna-canvas left"></canvas>
{% endblock %}

{% block use_container %}
    <section class="hero-section position-relative">
        <div class="medium-container text-white py-5 page-container">
            <h2 class="fancy-text text-center mb-5 text-glow">Welcome, {{ request.user.email }}</h2>

            {% include 'includes/messages.html' %}

            <div class="row gy-3 justify-content-center">

                <!-- Start Tracking -->
                <div class="col-md-5 info-box dashboard-box text-center mb-4">
                    <h4 class="dashboard-title text-center">Start Tracking</h4>
                    <div class="d-flex flex-column align-items-center gap-3">
                        <a href="{% url 'add_cardiology_record' %}" class="button-style w-100">Add Cardiology Record</a>
                        <a href="{% url 'add_endocrinology_record' %}" class="button-style w-100">Add Endocrinology
                            Record</a>
                    </div>
                </div>

                <!-- View History -->
                <div class="col-md-5 info-box dashboard-box text-center mb-4">
                    <h4 class="dashboard-title text-center">View History</h4>
                    <div class="d-flex flex-column align-items-center gap-3">
                        <a href="{% url 'cardiology_records_list' %}" class="button-style w-100">Cardiology Records</a>
                        <a href="{% url 'endocrinology_records_list' %}" class="button-style w-100">Endocrinology
                            Records</a>
                    </div>
                </div>

                <!-- View Health Table -->
                <div class="col-md-5 info-box dashboard-box text-center mb-4">
                    <h4 class="dashboard-title text-center">View Health Table</h4>
                    <a href="{% url 'chart_table' %}" class="button-style w-100">Open Table</a>
                </div>


                <!-- Doctor Connections -->
                <div class="col-md-5 info-box dashboard-box text-center mb-4">
                    <h4 class="dashboard-title text-center">Doctor Connections</h4>
                    <div class="d-flex flex-column align-items-center gap-3">
                        <a href="{% url 'patient-requests' %}" class="button-style w-100">View Doctor Invitations</a>
                        <a href="{% url 'patient-connections' %}" class="button-style w-100">View My Connections</a>
                    </div>
                </div>


                <!-- Book Appointment -->
                <div class="col-md-5 info-box dashboard-box text-center mb-4">
                    <h4 class="dashboard-title text-center">Book Appointment</h4>
                    {% if connections %}
                        <div class="d-flex flex-column align-items-center gap-2">
                            {% for link in connections %}
                                <a href="{% url 'appointment_create' %}" class="button-style w-100">
                                    Book with Dr. {{ link.doctor.email }} ({{ link.direction.name|title }})
                                </a>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">No connected doctors. Check your connections below.</p>
                    {% endif %}
                </div>

                <!-- Upcoming Appointments -->
                <div class="col-md-5 info-box dashboard-box text-center mb-4">
                    <h4 class="dashboard-title text-center">Upcoming Appointments</h4>
                    {% if upcoming_appointments %}
                        <ul class="list-group glass-card mb-4 text-start">
                            {% for appt in upcoming_appointments %}
                                <li class="list-group-item bg-transparent text-white border-light">
                                    <strong>Date:</strong> {{ appt.appointment_datetime|date:"d.m.Y H:i" }}<br>
                                    <strong>Doctor:</strong> {{ appt.doctor.email }}
                                    {% if appt.reason %}
                                        <br><strong>Reason:</strong> {{ appt.reason }}
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted text-center">No upcoming appointments.</p>
                    {% endif %}
                </div>


                <!-- Unread Notifications -->
                <div class="col-md-5 info-box dashboard-box text-center mb-4">
                    <h4 class="dashboard-title text-center">Unread Notifications</h4>
                    {% if unread_notifications %}
                        <ul class="list-group glass-card mb-4 text-start">
                            {% for notification in unread_notifications|slice:":5" %}
                                <li class="list-group-item bg-transparent text-white border-light">
                                    <a href="#" class="text-white text-decoration-none notification-item"
                                       data-id="{{ notification.id }}">
                                        <strong class="text-warning">{{ notification.get_notification_type_display }}</strong><br>
                                        {{ notification.message }}<br>
                                        <small class="text-muted">{{ notification.created_at|date:"d.m.Y H:i" }}</small>
                                    </a>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted text-center">No new notifications.</p>
                    {% endif %}
                    <a href="{% url 'notification_list' %}" class="button-style">View All Notifications</a>
                </div>


            </div>
        </div>
    </section>
{% endblock %}

{% block page_scripts %}
    {{ block.super }}
    <script src="{% static 'js/dna-left.js' %}"></script>
    <script src="{% static 'js/notifications.js' %}"></script>
{% endblock %}
